<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QA Hierarchy</title>

  <!-- Self-hosted OrgChart -->
  <script src="./orgchart.js"></script>

  <style>
    body {
      margin: 0;
      background: #F1F5F9; /* soft enterprise background */
      font-family: Arial, sans-serif;
    }

    #tree {
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>

<body>
  <div id="tree"></div>

  <script>
    if (!window.OrgChart) {
      document.body.innerHTML = "<h2 style='padding:20px'>OrgChart library not loaded</h2>";
      throw new Error("OrgChart not loaded");
    }

    /* ===============================
       TEMPLATE (PROFESSIONAL STYLE)
       =============================== */

    const templates = Object.keys(OrgChart.templates || {});
    const baseName = templates.includes("olivia") ? "olivia" : templates[0];
    const base = OrgChart.templates[baseName];

    OrgChart.templates.qa = Object.assign({}, base);
    OrgChart.templates.qa.size = [330, 115];

    // Card: white + subtle slate header
    OrgChart.templates.qa.node =
      '<rect x="0" y="0" width="330" height="115" rx="10" ry="10" fill="#FFFFFF" stroke="#CBD5E1" stroke-width="1.5"></rect>' +
      '<rect x="0" y="0" width="330" height="30" rx="10" ry="10" fill="#334155"></rect>';

    // Name
    OrgChart.templates.qa.field_0 =
      '<text data-width="310" data-text-overflow="multiline" data-text-line="2" ' +
      'style="font-size:15px;font-weight:600;" fill="#0F172A" ' +
      'x="165" y="56" text-anchor="middle">{val}</text>';

    // Title
    OrgChart.templates.qa.field_1 =
      '<text data-width="310" data-text-overflow="multiline" data-text-line="2" ' +
      'style="font-size:12px;" fill="#475569" ' +
      'x="165" y="84" text-anchor="middle">{val}</text>';

    /* ===============================
       DATA SOURCE
       =============================== */

    const DATA_URL =
      "https://script.google.com/macros/s/AKfycbygw8c5ss2yW5wneBny74TUhD9_aRQIEQWZ03UaPfUyyX2J2m0cj9P7ydPbs2fXW53r/exec";

    fetch(DATA_URL)
      .then(r => r.json())
      .then(data => {

        data.forEach(n => {
          if (n.pid === "" || n.pid === null) delete n.pid;
          n.id = String(n.id);
          if (n.pid !== undefined) n.pid = String(n.pid);
        });

        /* ===============================
           RENDER CHART
           =============================== */

        new OrgChart(document.getElementById("tree"), {
          template: "qa",

          // ❌ remove search bar
          enableSearch: false,

          // ❌ remove right details panel
          nodeMouseClick: OrgChart.action.center,

          // ❌ remove node menus
          nodeMenu: null,
          nodeContextMenu: null,

          // Vertical layout
          layout: OrgChart.tree,
          orientation: OrgChart.orientation.top,
          levelSeparation: 70,
          siblingSeparation: 30,
          subtreeSeparation: 80,

          // Zoom & fit (toolbar only)
          scaleInitial: OrgChart.match.boundary,
          minScale: 0.2,
          maxScale: 2,
          mouseScrool: OrgChart.action.zoom,
          toolbar: {
            zoom: true,
            fit: true,
            expandAll: true
          },

          nodeBinding: {
            field_0: "name",
            field_1: "title"
          },

          nodes: data
        });
      })
      .catch(err => {
        console.error(err);
        document.body.innerHTML = "<h2 style='padding:20px'>Failed to load data</h2>";
      });
  </script>
</body>
</html>

