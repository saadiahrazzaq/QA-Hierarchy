<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QA Hierarchy</title>

  <!-- Self-hosted OrgChart -->
  <script src="./orgchart.js"></script>

  <style>
    body { margin:0; background:#062233; font-family: Arial, sans-serif; }
    #tree { width:100vw; height:100vh; }
    #status {
      position: fixed; top: 12px; left: 12px; z-index: 9999;
      background: rgba(255,255,255,0.92);
      padding: 10px 12px; border-radius: 10px;
      max-width: 760px; font-size: 14px; line-height: 1.35;
    }
    code { font-family: Consolas, monospace; font-size: 12px; }
  </style>
</head>

<body>
  <div id="status">Loading…</div>
  <div id="tree"></div>

  <script>
    const statusEl = document.getElementById("status");
    const DATA_URL = "https://script.google.com/macros/s/AKfycbygw8c5ss2yW5wneBny74TUhD9_aRQIEQWZ03UaPfUyyX2J2m0cj9P7ydPbs2fXW53r/exec";

    function setStatus(html) { statusEl.innerHTML = html; }

    // 1) Check OrgChart loaded
    if (typeof OrgChart === "undefined") {
      setStatus("❌ <b>OrgChart not loaded</b><br>Make sure <code>orgchart.js</code> exists in your repo root.");
      throw new Error("OrgChart is undefined");
    }

    // 2) Pick an existing template that your orgchart.js actually contains
    const available = OrgChart.templates ? Object.keys(OrgChart.templates) : [];
    const baseName =
      (available.includes("olivia") && "olivia") ||
      (available.includes("ula") && "ula") ||
      (available.includes("ana") && "ana") ||
      available[0];

    if (!baseName) {
      setStatus("❌ <b>No templates found</b><br>Your <code>orgchart.js</code> build has no templates.");
      throw new Error("No templates");
    }

    // 3) Clone base template + override only visuals/text
    OrgChart.templates.qa = Object.assign({}, OrgChart.templates[baseName]);

    // Bigger node size
    OrgChart.templates.qa.size = [360, 140];

    // Yellow node background
    OrgChart.templates.qa.node =
      '<rect x="0" y="0" width="360" height="140" rx="16" ry="16" fill="#FFC107" stroke="#FFB300" stroke-width="2"></rect>' +
      '<rect x="0" y="0" width="360" height="36" rx="16" ry="16" fill="#FFB300"></rect>';

    // Name (wrap, 2 lines)
    OrgChart.templates.qa.field_0 =
      '<text data-width="340" data-text-overflow="multiline" data-text-line="2" ' +
      'style="font-size:18px;font-weight:700;" fill="#1a1a1a" x="180" y="62" text-anchor="middle">{val}</text>';

    // Title (wrap, 2 lines)
    OrgChart.templates.qa.field_1 =
      '<text data-width="340" data-text-overflow="multiline" data-text-line="2" ' +
      'style="font-size:13px;" fill="#333" x="180" y="102" text-anchor="middle">{val}</text>';

    setStatus("✅ Library loaded. Fetching data…");

    // 4) Fetch data
    fetch(DATA_URL)
      .then(r => {
        if (!r.ok) throw new Error("Data fetch failed: HTTP " + r.status);
        return r.json();
      })
      .then(data => {
        // Fix root + types
        data.forEach(n => {
          if (n.pid === "" || n.pid === null) delete n.pid;
          n.id = String(n.id);
          if (n.pid !== undefined) n.pid = String(n.pid);
        });

        setStatus("✅ Data loaded (" + data.length + " nodes). Rendering…");

        // 5) Render
        new OrgChart(document.getElementById("tree"), {
          template: "qa",
          enableSearch: true,

          // Fit + zoom
          scaleInitial: OrgChart.match.boundary,
          minScale: 0.12,
          maxScale: 2,
          mouseScrool: OrgChart.action.zoom,
          toolbar: { zoom: true, fit: true, expandAll: true },

          nodeBinding: { field_0: "name", field_1: "title" },
          nodes: data
        });

        setStatus("✅ Done. Use toolbar: Fit / Zoom / Search.");
        setTimeout(() => statusEl.style.display = "none", 1800);
      })
      .catch(err => {
        console.error(err);
        setStatus("❌ <b>Error</b><br><code>" + err.message + "</code><br><br>Open Console tab for details.");
      });
  </script>
</body>
</html>
