<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QA Hierarchy</title>

  <!-- Self-hosted OrgChart library -->
  <script src="./orgchart.js"></script>

  <style>
    body { margin:0; background:#F6F8FA; font-family: Arial, sans-serif; }
    #tree { width:100vw; height:100vh; }
    #status {
      position: fixed; top: 12px; left: 12px; z-index: 9999;
      background: rgba(0,0,0,0.82); color: #fff;
      padding: 10px 12px; border-radius: 10px;
      max-width: 820px; font-size: 14px; line-height: 1.35;
    }
    code { font-family: Consolas, monospace; font-size: 12px; }
  </style>
</head>

<body>
  <div id="status">Loading…</div>
  <div id="tree"></div>

  <script>
    const statusEl = document.getElementById("status");
    const DATA_URL =
      "https://script.google.com/a/macros/venturedive.com/s/AKfycbzEoXPpUbFVUIZiM2YiF6vONK3J_RGjmhAz-FPluMrIr1wBcqGHx84sAcYML_kGUAdd/exec";

    const setStatus = (html) => statusEl.innerHTML = html;

    try {
      // 1) Verify OrgChart loaded
      if (typeof OrgChart === "undefined") {
        setStatus("❌ OrgChart not loaded.<br>Check: <code>https://YOURNAME.github.io/QA-Hierarchy/orgchart.js</code> is not 404.");
        throw new Error("OrgChart is undefined");
      }

      // 2) Find an available base template in YOUR build
      const templates = (OrgChart.templates && Object.keys(OrgChart.templates)) ? Object.keys(OrgChart.templates) : [];
      if (!templates.length) {
        setStatus("❌ No templates found in your <code>orgchart.js</code> build.");
        throw new Error("No templates in OrgChart.templates");
      }

      const baseName = templates.includes("olivia") ? "olivia" : templates[0];
      const base = OrgChart.templates[baseName];

      // 3) Clone base template safely + customize look
      OrgChart.templates.qa = Object.assign({}, base);
      OrgChart.templates.qa.size = [360, 140];

      // Standard enterprise card: white + blue header
      OrgChart.templates.qa.node =
        '<rect x="0" y="0" width="360" height="140" rx="14" ry="14" fill="#FFFFFF" stroke="#D0D7DE" stroke-width="2"></rect>' +
        '<rect x="0" y="0" width="360" height="36" rx="14" ry="14" fill="#0B5FFF"></rect>';

      OrgChart.templates.qa.field_0 =
        '<text data-width="330" data-text-overflow="multiline" data-text-line="2" ' +
        'style="font-size:18px;font-weight:700;" fill="#111827" x="180" y="62" text-anchor="middle">{val}</text>';

      OrgChart.templates.qa.field_1 =
        '<text data-width="330" data-text-overflow="multiline" data-text-line="2" ' +
        'style="font-size:13px;" fill="#374151" x="180" y="102" text-anchor="middle">{val}</text>';

      setStatus("✅ OrgChart loaded. Template: <b>" + baseName + "</b><br>Fetching data…");

      // 4) Fetch data + render
      fetch(DATA_URL)
        .then(r => {
          if (!r.ok) throw new Error("Data fetch failed: HTTP " + r.status);
          return r.json();
        })
        .then(data => {
          data.forEach(n => {
            if (n.pid === "" || n.pid === null) delete n.pid;
            n.id = String(n.id);
            if (n.pid !== undefined) n.pid = String(n.pid);
          });

          setStatus("✅ Data loaded (" + data.length + " nodes). Rendering…");

          new OrgChart(document.getElementById("tree"), {
            template: "qa",
            enableSearch: true,

            // Vertical
            layout: OrgChart.tree,
            orientation: OrgChart.orientation.top,

            // Fit + zoom
            scaleInitial: OrgChart.match.boundary,
            minScale: 0.15,
            maxScale: 2,
            mouseScrool: OrgChart.action.zoom,
            toolbar: { zoom: true, fit: true, expandAll: true },

            nodeBinding: { field_0: "name", field_1: "title" },
            nodes: data
          });

          setStatus("✅ Done. Use toolbar: Fit / Zoom / Search.");
          setTimeout(() => statusEl.style.display = "none", 1500);
        })
        .catch(err => {
          console.error(err);
          setStatus("❌ Error: <code>" + err.message + "</code><br>Open Console for details.");
        });

    } catch (e) {
      console.error(e);
      // status already set above
    }
  </script>
</body>
</html>

